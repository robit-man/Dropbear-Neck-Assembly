<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Robotic Neck Control</title>
  <link rel="stylesheet" href="./style.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nkn-sdk@1.3.6/dist/nkn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
    }
  }
  </script>
  <script src="./script.js" defer></script>
  <script type="module" src="./headstream-module.js"></script>
  <script type="module" src="./orientation-module.js"></script>
</head>
<body>
  <div id="connectionModal" class="modal">
    <div class="modal-content">
      <button id="connectionModalCloseBtn" class="modal-close-btn" type="button" aria-label="Close Settings">x</button>
      <div class="modal-header">NKN Router Discovery</div>

      <div class="modal-section">
        <h3 style="margin-top:0;">NKN Router Discovery</h3>
        <div class="row">
          <label for="routerNknAddressInput">Router NKN Address:</label>
          <input type="text" id="routerNknAddressInput" placeholder="router.<pubkey-hex>" style="flex:1;">
        </div>
        <div class="row">
          <button id="routerResolveBtn" class="primary">Resolve Endpoints via NKN DM</button>
          <button id="routerRefreshInfoBtn">Reconnect Browser NKN</button>
          <button id="routerScanQrBtn" type="button">Scan Router QR</button>
        </div>
        <div class="nkn-identity-grid">
          <div class="nkn-identity-meta">
            <div class="nkn-meta-label">Browser Seed</div>
            <div id="browserNknSeedStatus" class="nkn-meta-value">Initializing...</div>
            <div class="nkn-meta-label">Browser Pubkey (hex)</div>
            <code id="browserNknPubkey" class="nkn-code">Pending...</code>
          </div>
          <div id="browserNknQr" class="nkn-qr" aria-label="Browser NKN pubkey QR"></div>
        </div>
        <div id="routerQrScannerPanel" class="nkn-scan-panel" hidden>
          <video id="routerQrScannerVideo" class="nkn-scan-video" autoplay muted playsinline></video>
          <div class="row">
            <button id="routerQrScannerStopBtn" type="button">Stop Scan</button>
            <span id="routerQrScannerStatus" class="nkn-scan-status">Scanner idle</span>
          </div>
        </div>
        <p id="routerResolveStatus" style="overflow:auto;font-size:0.85rem;opacity:0.85;margin:0.5rem 0 0 0;">NKN idle</p>
      </div>
    </div>
  </div>

  <header id="appTopHeader" class="app-top-header">
    <div id="sidebarSwipeZone" class="sidebar-swipe-zone" aria-label="Swipe right to open menu"></div>
    <div class="service-chip-row service-status-row">
      <button id="svcChipRouter" class="service-status-btn disconnected" type="button" aria-label="Router endpoint status">
        <span class="service-status-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="7"></circle><circle cx="12" cy="12" r="2.5"></circle><path d="M12 2v3"></path><path d="M12 19v3"></path><path d="M2 12h3"></path><path d="M19 12h3"></path></svg>
        </span>
        <span class="service-status-label">Router</span>
        <span class="service-status-value">Offline</span>
      </button>
      <button id="svcChipAdapter" class="service-status-btn disconnected" type="button" aria-label="Adapter endpoint status">
        <span class="service-status-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M8 7v5a4 4 0 0 0 8 0V7"></path><path d="M9 3v4"></path><path d="M15 3v4"></path><path d="M12 16v5"></path></svg>
        </span>
        <span class="service-status-label">Adapter</span>
        <span class="service-status-value">Offline</span>
      </button>
      <button id="svcChipCamera" class="service-status-btn disconnected" type="button" aria-label="Camera endpoint status">
        <span class="service-status-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24"><rect x="3" y="6" width="14" height="12" rx="2"></rect><path d="m17 10 4-2v8l-4-2"></path></svg>
        </span>
        <span class="service-status-label">Camera</span>
        <span class="service-status-value">Offline</span>
      </button>
      <button id="svcChipAudio" class="service-status-btn disconnected" type="button" aria-label="Audio endpoint status">
        <span class="service-status-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24"><rect x="9" y="3" width="6" height="11" rx="3"></rect><path d="M5 11a7 7 0 0 0 14 0"></path><path d="M12 18v3"></path><path d="M8 21h8"></path></svg>
        </span>
        <span class="service-status-label">Audio</span>
        <span class="service-status-value">Offline</span>
      </button>
      <button id="svcChipHybrid" class="service-status-btn disconnected" type="button" aria-label="Hybrid endpoint status">
        <span class="service-status-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24"><rect x="5" y="8" width="14" height="9" rx="3"></rect><path d="M8 12h4"></path><path d="M10 10v4"></path><circle cx="16" cy="11" r="1"></circle><circle cx="17.5" cy="13.5" r="1"></circle></svg>
        </span>
        <span class="service-status-label">Hybrid</span>
        <span class="service-status-value">Offline</span>
      </button>
    </div>
  </header>

  <div class="app-shell">
    <aside id="appSidebar" class="app-sidebar">
      <div class="sidebar-header">
        <button id="sidebarToggleBtn" class="sidebar-toggle-btn" type="button" aria-expanded="true" aria-label="Close sidebar">
          <span class="sidebar-toggle-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="m6 6 12 12"></path><path d="m18 6-12 12"></path></svg>
          </span>
        </button>
      </div>
      <div class="sidebar-content">
        <details class="sidebar-section" open>
          <summary>Status</summary>
          <div class="metrics-bar">
            <div class="metric">
              <div class="metric-label">Control Transport</div>
              <div id="metricStatus" class="metric-value">Checking...</div>
              <div id="metricLatency" class="metric-meta">Latency --</div>
            </div>
            <div class="metric">
              <div class="metric-label">Control Datastream</div>
              <div id="metricRate" class="metric-value">0 cmd/s</div>
              <div id="metricCommands" class="metric-meta">0 commands</div>
            </div>
            <div class="metric">
              <div class="metric-label">Video Datastream</div>
              <div id="metricVideoState" class="metric-value">Idle</div>
              <div id="metricVideoStats" class="metric-meta">-- fps | -- kbps | -- clients</div>
            </div>
          </div>
        </details>

        <details class="sidebar-section" open>
          <summary>Navigation</summary>
          <nav>
            <div class="nav-container controls-nav" id="controlsNav">
              <a href="#auth" class="nav-link" data-route="auth">Auth</a>
              <a href="#hybrid" class="nav-link" data-route="hybrid">Hybrid</a>
              <a href="#debug" class="nav-link" data-route="debug">Debug</a>
            </div>
          </nav>
        </details>
      </div>
    </aside>
    <div id="sidebarScrim" class="sidebar-scrim" hidden></div>

    <main class="app-main">
      <div class="container">

    <section class="view" data-view="auth">
      <h2>Service Authentication</h2>
      <details class="streams-panel" open>
        <summary>Router NKN</summary>
        <div id="authRouterMount" class="streams-panel-body"></div>
      </details>
      <details class="streams-panel" open>
        <summary>Adapter Service</summary>
        <div id="authAdapterMount" class="streams-panel-body"></div>
      </details>
      <details class="streams-panel" open>
        <summary>Camera Service</summary>
        <div id="authCameraMount" class="streams-panel-body"></div>
      </details>
      <details class="streams-panel" open>
        <summary>Audio Service</summary>
        <div id="authAudioMount" class="streams-panel-body"></div>
      </details>
    </section>

    <section class="view" data-view="connect">
      <h1>Robotic Neck Control</h1>
      <div class="control-section">
        <p>Use Settings to connect to the NKN router, then open Neck to authenticate with the adapter.</p>
        <p style="opacity:0.7;font-size:0.9rem;">
          The adapter must be running and reachable at the specified URL.
          Default password is "neck2025" unless changed in adapter config.
        </p>
      </div>
      <div class="control-section">
        <button class="primary" onclick="setRoute('neck')">Proceed to Controls -&gt;</button>
      </div>
    </section>

    <section class="view" data-view="neck">
      <h2>Stewart Platform Control Interface</h2>
      <div class="control-section">
        <h3 style="margin-top:0;">Neck Adapter Connection</h3>
        <div class="column">
          <label for="adapterAddressInput">Adapter Address:</label>
          <input type="text" id="adapterAddressInput" placeholder="https://example.trycloudflare.com or 127.0.0.1:5160">
          <input type="hidden" id="httpUrlInput">
          <input type="hidden" id="wsUrlInput">
          <p style="font-size:0.85rem;opacity:0.75;margin:0;">
            Resolved NKN adapter endpoint is injected here and normalized to /send_command + /ws.
          </p>
          <p id="adapterEndpointPreview" style="font-size:0.82rem;opacity:0.82;margin:0;">No adapter endpoint resolved yet.</p>
        </div>
        <div class="column">
          <label for="passwordInput">Password:</label>
          <input type="password" id="passwordInput" placeholder="Enter adapter password">
        </div>
        <div class="row">
          <button onclick="connectToAdapter()" class="primary">Connect Adapter</button>
          <button onclick="fetchTunnelUrl()">Normalize Address</button>
        </div>
      </div>
      <div class="control-section">
        <p>Select a control mode from the navigation menu above.</p>
        <ul style="line-height:1.8;">
          <li><strong>Direct Motor:</strong> Control each of the 6 actuators individually</li>
          <li><strong>Euler:</strong> Control yaw, pitch, roll, and height</li>
          <li><strong>Full Head:</strong> Complete head control with speed/acceleration</li>
          <li><strong>Quaternion:</strong> Quaternion-based orientation control</li>
          <li><strong>Morphtarget:</strong> Real-time face tracking control</li>
          <li><strong>Orientation:</strong> Device orientation stream control with planet/planar mapping</li>
        </ul>
      </div>
    </section>

    <section class="view" data-view="direct">
      <h2>Direct Motor Control</h2>

      <div class="control-section">
        <div class="row">
          <label>Motor 1:</label>
          <button onclick="decMotor(1)">-</button>
          <input type="number" id="motor1" value="0" onchange="updateDirect()" style="width:80px;">
          <button onclick="incMotor(1)">+</button>
          <input type="range" id="slider1" min="0" max="80" value="0" oninput="document.getElementById('motor1').value=this.value; updateDirect();">
        </div>
        <div class="row">
          <label>Motor 2:</label>
          <button onclick="decMotor(2)">-</button>
          <input type="number" id="motor2" value="0" onchange="updateDirect()" style="width:80px;">
          <button onclick="incMotor(2)">+</button>
          <input type="range" id="slider2" min="0" max="80" value="0" oninput="document.getElementById('motor2').value=this.value; updateDirect();">
        </div>
        <div class="row">
          <label>Motor 3:</label>
          <button onclick="decMotor(3)">-</button>
          <input type="number" id="motor3" value="0" onchange="updateDirect()" style="width:80px;">
          <button onclick="incMotor(3)">+</button>
          <input type="range" id="slider3" min="0" max="80" value="0" oninput="document.getElementById('motor3').value=this.value; updateDirect();">
        </div>
        <div class="row">
          <label>Motor 4:</label>
          <button onclick="decMotor(4)">-</button>
          <input type="number" id="motor4" value="0" onchange="updateDirect()" style="width:80px;">
          <button onclick="incMotor(4)">+</button>
          <input type="range" id="slider4" min="0" max="80" value="0" oninput="document.getElementById('motor4').value=this.value; updateDirect();">
        </div>
        <div class="row">
          <label>Motor 5:</label>
          <button onclick="decMotor(5)">-</button>
          <input type="number" id="motor5" value="0" onchange="updateDirect()" style="width:80px;">
          <button onclick="incMotor(5)">+</button>
          <input type="range" id="slider5" min="0" max="80" value="0" oninput="document.getElementById('motor5').value=this.value; updateDirect();">
        </div>
        <div class="row">
          <label>Motor 6:</label>
          <button onclick="decMotor(6)">-</button>
          <input type="number" id="motor6" value="0" onchange="updateDirect()" style="width:80px;">
          <button onclick="incMotor(6)">+</button>
          <input type="range" id="slider6" min="0" max="80" value="0" oninput="document.getElementById('motor6').value=this.value; updateDirect();">
        </div>
      </div>

      <div class="control-section">
        <h3 style="margin-top:0;">Manual Command</h3>
        <div class="row">
          <input type="text" id="directCmdInput" placeholder="e.g., 1:30,2:45" style="flex:1;">
          <button onclick="sendCommand(document.getElementById('directCmdInput').value)" class="primary">Send</button>
        </div>
        <p style="margin:0.5rem 0 0 0;opacity:0.7;">Current: <span id="directCurrentCmd" class="current-command"></span></p>
      </div>
    </section>

    <section class="view" data-view="euler">
      <h2>Euler Control</h2>

      <div class="control-section">
        <div class="row">
          <label>Yaw (X):</label>
          <button onclick="decEulerField('yaw')">-</button>
          <input type="number" id="yaw" value="0" onchange="updateEulerView()" style="width:80px;">
          <button onclick="incEulerField('yaw')">+</button>
          <input type="range" id="yawSlider" min="-800" max="800" value="0" oninput="document.getElementById('yaw').value=this.value; updateEulerView();">
        </div>
        <div class="row">
          <label>Roll (Y):</label>
          <button onclick="decEulerField('roll')">-</button>
          <input type="number" id="roll" value="0" onchange="updateEulerView()" style="width:80px;">
          <button onclick="incEulerField('roll')">+</button>
          <input type="range" id="rollSlider" min="-800" max="800" value="0" oninput="document.getElementById('roll').value=this.value; updateEulerView();">
        </div>
        <div class="row">
          <label>Pitch (Z):</label>
          <button onclick="decEulerField('pitch')">-</button>
          <input type="number" id="pitch" value="0" onchange="updateEulerView()" style="width:80px;">
          <button onclick="incEulerField('pitch')">+</button>
          <input type="range" id="pitchSlider" min="-800" max="800" value="0" oninput="document.getElementById('pitch').value=this.value; updateEulerView();">
        </div>
        <div class="row">
          <label>Height (H):</label>
          <button onclick="decEulerField('height')">-</button>
          <input type="number" id="height" value="0" onchange="updateEulerView()" style="width:80px;">
          <button onclick="incEulerField('height')">+</button>
          <input type="range" id="heightSlider" min="0" max="70" value="0" oninput="document.getElementById('height').value=this.value; updateEulerView();">
        </div>
      </div>

      <div class="control-section">
        <h3 style="margin-top:0;">Manual Command</h3>
        <div class="row">
          <input type="text" id="eulerCmdInput" placeholder="e.g., X30,Y15,Z-10,H50" style="flex:1;">
          <button onclick="sendCommand(document.getElementById('eulerCmdInput').value)" class="primary">Send</button>
        </div>
        <p style="margin:0.5rem 0 0 0;opacity:0.7;">Current: <span id="eulerCurrentCmd" class="current-command"></span></p>
      </div>
    </section>

    <section class="view" data-view="head">
      <h2>Full Head Control</h2>

      <div class="control-section">
        <h3 style="margin-top:0;">Position &amp; Orientation</h3>
        <div class="row">
          <label>Yaw (X):</label>
          <button onclick="decHeadField('X', 1)">-</button>
          <input type="number" id="X" value="0" onchange="updateHeadView()" style="width:80px;">
          <button onclick="incHeadField('X', 1)">+</button>
          <input type="range" id="XSlider" min="-800" max="800" value="0" oninput="document.getElementById('X').value=this.value; updateHeadView();">
        </div>
        <div class="row">
          <label>Lateral (Y):</label>
          <button onclick="decHeadField('Y', 1)">-</button>
          <input type="number" id="Y" value="0" onchange="updateHeadView()" style="width:80px;">
          <button onclick="incHeadField('Y', 1)">+</button>
          <input type="range" id="YSlider" min="-800" max="800" value="0" oninput="document.getElementById('Y').value=this.value; updateHeadView();">
        </div>
        <div class="row">
          <label>Front/Back (Z):</label>
          <button onclick="decHeadField('Z', 1)">-</button>
          <input type="number" id="Z" value="0" onchange="updateHeadView()" style="width:80px;">
          <button onclick="incHeadField('Z', 1)">+</button>
          <input type="range" id="ZSlider" min="-800" max="800" value="0" oninput="document.getElementById('Z').value=this.value; updateHeadView();">
        </div>
        <div class="row">
          <label>Height (H):</label>
          <button onclick="decHeadField('H', 1)">-</button>
          <input type="number" id="H" value="0" onchange="updateHeadView()" style="width:80px;">
          <button onclick="incHeadField('H', 1)">+</button>
          <input type="range" id="HSlider" min="0" max="70" value="0" oninput="document.getElementById('H').value=this.value; updateHeadView();">
        </div>
        <div class="row">
          <label>Roll (R):</label>
          <button onclick="decHeadField('R', 1)">-</button>
          <input type="number" id="R" value="0" onchange="updateHeadView()" style="width:80px;">
          <button onclick="incHeadField('R', 1)">+</button>
          <input type="range" id="RSlider" min="-800" max="800" value="0" oninput="document.getElementById('R').value=this.value; updateHeadView();">
        </div>
        <div class="row">
          <label>Pitch (P):</label>
          <button onclick="decHeadField('P', 1)">-</button>
          <input type="number" id="P" value="0" onchange="updateHeadView()" style="width:80px;">
          <button onclick="incHeadField('P', 1)">+</button>
          <input type="range" id="PSlider" min="-800" max="800" value="0" oninput="document.getElementById('P').value=this.value; updateHeadView();">
        </div>
      </div>

      <div class="control-section">
        <h3 style="margin-top:0;">Motion Parameters</h3>
        <div class="row">
          <label>Speed (S):</label>
          <button onclick="decHeadField('S', 0.1)">-</button>
          <input type="number" id="S" value="1" step="0.1" onchange="updateHeadView()" style="width:80px;">
          <button onclick="incHeadField('S', 0.1)">+</button>
          <input type="range" id="SSlider" min="0" max="10" step="0.1" value="1" oninput="document.getElementById('S').value=this.value; updateHeadView();">
        </div>
        <div class="row">
          <label>Acceleration (A):</label>
          <button onclick="decHeadField('A', 0.1)">-</button>
          <input type="number" id="A" value="1" step="0.1" onchange="updateHeadView()" style="width:80px;">
          <button onclick="incHeadField('A', 0.1)">+</button>
          <input type="range" id="ASlider" min="0" max="10" step="0.1" value="1" oninput="document.getElementById('A').value=this.value; updateHeadView();">
        </div>
      </div>

      <div class="control-section">
        <h3 style="margin-top:0;">Manual Command</h3>
        <div class="row">
          <input type="text" id="headCmdInput" placeholder="e.g., X30,Y0,Z10,H-40,S1,A1,R0,P0" style="flex:1;">
          <button onclick="sendCommand(document.getElementById('headCmdInput').value)" class="primary">Send</button>
        </div>
        <p style="margin:0.5rem 0 0 0;opacity:0.7;">Current: <span id="headCurrentCmd" class="current-command"></span></p>
      </div>
    </section>

    <section class="view" data-view="quaternion">
      <h2>Quaternion Control</h2>

      <div class="control-section">
        <h3 style="margin-top:0;">Quaternion Components</h3>
        <div class="row">
          <label>W:</label>
          <button onclick="decQuatField('w', 0.1)">-</button>
          <input type="number" id="w" value="1" step="0.1" onchange="updateQuatView()" style="width:80px;">
          <button onclick="incQuatField('w', 0.1)">+</button>
          <input type="range" id="wSlider" min="0" max="1" step="0.01" value="1" oninput="document.getElementById('w').value=this.value; updateQuatView();">
        </div>
        <div class="row">
          <label>X:</label>
          <button onclick="decQuatField('x', 0.1)">-</button>
          <input type="number" id="x" value="0" step="0.1" onchange="updateQuatView()" style="width:80px;">
          <button onclick="incQuatField('x', 0.1)">+</button>
          <input type="range" id="xSlider" min="-1" max="1" step="0.01" value="0" oninput="document.getElementById('x').value=this.value; updateQuatView();">
        </div>
        <div class="row">
          <label>Y:</label>
          <button onclick="decQuatField('y', 0.1)">-</button>
          <input type="number" id="y" value="0" step="0.1" onchange="updateQuatView()" style="width:80px;">
          <button onclick="incQuatField('y', 0.1)">+</button>
          <input type="range" id="ySlider" min="-1" max="1" step="0.01" value="0" oninput="document.getElementById('y').value=this.value; updateQuatView();">
        </div>
        <div class="row">
          <label>Z:</label>
          <button onclick="decQuatField('z', 0.1)">-</button>
          <input type="number" id="z" value="0" step="0.1" onchange="updateQuatView()" style="width:80px;">
          <button onclick="incQuatField('z', 0.1)">+</button>
          <input type="range" id="zSlider" min="-1" max="1" step="0.01" value="0" oninput="document.getElementById('z').value=this.value; updateQuatView();">
        </div>
      </div>

      <div class="control-section">
        <h3 style="margin-top:0;">Position &amp; Motion</h3>
        <div class="row">
          <label>Height (H):</label>
          <button onclick="decQuatField('qH', 1)">-</button>
          <input type="number" id="qH" value="0" onchange="updateQuatView()" style="width:80px;">
          <button onclick="incQuatField('qH', 1)">+</button>
          <input type="range" id="qHSlider" min="0" max="70" value="0" oninput="document.getElementById('qH').value=this.value; updateQuatView();">
        </div>
        <div class="row">
          <label>Speed (S):</label>
          <button onclick="decQuatField('qS', 0.1)">-</button>
          <input type="number" id="qS" value="1" step="0.1" onchange="updateQuatView()" style="width:80px;">
          <button onclick="incQuatField('qS', 0.1)">+</button>
          <input type="range" id="qSSlider" min="0" max="10" step="0.1" value="1" oninput="document.getElementById('qS').value=this.value; updateQuatView();">
        </div>
        <div class="row">
          <label>Acceleration (A):</label>
          <button onclick="decQuatField('qA', 0.1)">-</button>
          <input type="number" id="qA" value="1" step="0.1" onchange="updateQuatView()" style="width:80px;">
          <button onclick="incQuatField('qA', 0.1)">+</button>
          <input type="range" id="qASlider" min="0" max="10" step="0.1" value="1" oninput="document.getElementById('qA').value=this.value; updateQuatView();">
        </div>
      </div>

      <div class="control-section">
        <h3 style="margin-top:0;">Manual Command</h3>
        <div class="row">
          <input type="text" id="quatCmdInput" placeholder="e.g., Q:1,0,0,0,H50,S1,A1" style="flex:1;">
          <button onclick="sendCommand(document.getElementById('quatCmdInput').value)" class="primary">Send</button>
        </div>
        <p style="margin:0.5rem 0 0 0;opacity:0.7;">Current: <span id="quatCurrentCmd" class="current-command"></span></p>
      </div>
    </section>

    <section class="view" data-view="headstream">
      <h2>Morphtarget</h2>

      <div class="control-section">
        <h3 style="margin-top:0;">Head Pose Command Stream</h3>
        <p style="opacity:0.75;margin-top:0;">
          Track your face and stream X/Y/Z/H/S/A/R/P commands to the adapter.
        </p>

        <div id="morphCanvasWrap"></div>

        <div class="stream-grid">
          <div class="stream-card">
            <div class="stream-label">Stream Status</div>
            <div id="streamStatus" class="stream-value">Initializing...</div>
          </div>
          <div class="stream-card">
            <div class="stream-label">Last Command</div>
            <div id="commandStream" class="stream-value">Waiting for head pose...</div>
          </div>
        </div>
      </div>

      <div class="control-section">
        <h3 style="margin-top:0;">Morphtarget Tuneables</h3>
        <p class="tuneables-note">These settings apply live while tracking.</p>

        <div class="row" style="margin-bottom:0.5rem;">
          <button id="streamToggleBtn" class="primary">Play Stream</button>
          <button id="recenterPoseBtn">Recenter</button>
          <button id="resetTuneablesBtn">Reset Tuneables</button>
        </div>

        <div class="row">
          <label for="tuneLateralGain">Lateral Gain (Y):</label>
          <input type="number" id="tuneLateralGain" min="0" max="20" step="0.1" value="1.8" style="width:90px;">
          <input type="range" id="tuneLateralGainRange" min="0" max="20" step="0.1" value="1.8">
        </div>
        <div class="row">
          <label for="tuneFrontBackGain">Front/Back Gain (Z):</label>
          <input type="number" id="tuneFrontBackGain" min="0" max="20" step="0.1" value="1.6" style="width:90px;">
          <input type="range" id="tuneFrontBackGainRange" min="0" max="20" step="0.1" value="1.6">
        </div>
        <div class="row">
          <label for="tuneHeightGain">Height Gain (H):</label>
          <input type="number" id="tuneHeightGain" min="0" max="30" step="0.1" value="2.5" style="width:90px;">
          <input type="range" id="tuneHeightGainRange" min="0" max="30" step="0.1" value="2.5">
        </div>
        <div class="row">
          <label for="tuneYawGain">Yaw Gain (X):</label>
          <input type="number" id="tuneYawGain" min="0" max="40" step="0.1" value="4.8" style="width:90px;">
          <input type="range" id="tuneYawGainRange" min="0" max="40" step="0.1" value="4.8">
        </div>
        <div class="row">
          <label for="tunePitchGain">Pitch Gain (P):</label>
          <input type="number" id="tunePitchGain" min="-60" max="0" step="0.1" value="-7" style="width:90px;">
          <input type="range" id="tunePitchGainRange" min="-60" max="0" step="0.1" value="-7">
        </div>
        <div class="row">
          <label for="tuneRollGain">Roll Gain (R):</label>
          <input type="number" id="tuneRollGain" min="-60" max="0" step="0.1" value="-6" style="width:90px;">
          <input type="range" id="tuneRollGainRange" min="-60" max="0" step="0.1" value="-6">
        </div>
        <div class="row">
          <label for="tuneSmoothAlpha">Smoothing (alpha):</label>
          <input type="number" id="tuneSmoothAlpha" min="0.1" max="0.95" step="0.01" value="0.45" style="width:90px;">
          <input type="range" id="tuneSmoothAlphaRange" min="0.1" max="0.95" step="0.01" value="0.45">
        </div>
        <div class="row">
          <label for="tuneIntervalMs">Send Interval (ms):</label>
          <input type="number" id="tuneIntervalMs" min="20" max="200" step="1" value="90" style="width:90px;">
          <input type="range" id="tuneIntervalMsRange" min="20" max="200" step="1" value="90">
        </div>
        <div class="row">
          <label for="tuneStreamSpeed">Speed (S):</label>
          <input type="number" id="tuneStreamSpeed" min="0" max="10" step="0.1" value="0.8" style="width:90px;">
          <input type="range" id="tuneStreamSpeedRange" min="0" max="10" step="0.1" value="0.8">
        </div>
        <div class="row">
          <label for="tuneStreamAccel">Acceleration (A):</label>
          <input type="number" id="tuneStreamAccel" min="0" max="10" step="0.1" value="0.6" style="width:90px;">
          <input type="range" id="tuneStreamAccelRange" min="0" max="10" step="0.1" value="0.6">
        </div>
        <div class="row">
          <label for="tuneOffsetX">Offset X:</label>
          <input type="number" id="tuneOffsetX" min="-800" max="800" step="1" value="0" style="width:90px;">
          <input type="range" id="tuneOffsetXRange" min="-800" max="800" step="1" value="0">
        </div>
        <div class="row">
          <label for="tuneOffsetY">Offset Y:</label>
          <input type="number" id="tuneOffsetY" min="-800" max="800" step="1" value="0" style="width:90px;">
          <input type="range" id="tuneOffsetYRange" min="-800" max="800" step="1" value="0">
        </div>
        <div class="row">
          <label for="tuneOffsetZ">Offset Z:</label>
          <input type="number" id="tuneOffsetZ" min="-800" max="800" step="1" value="0" style="width:90px;">
          <input type="range" id="tuneOffsetZRange" min="-800" max="800" step="1" value="0">
        </div>
        <div class="row">
          <label for="tuneOffsetH">Offset H:</label>
          <input type="number" id="tuneOffsetH" min="0" max="70" step="1" value="30" style="width:90px;">
          <input type="range" id="tuneOffsetHRange" min="0" max="70" step="1" value="30">
        </div>
        <div class="row">
          <label for="tuneOffsetR">Offset R:</label>
          <input type="number" id="tuneOffsetR" min="-800" max="800" step="1" value="0" style="width:90px;">
          <input type="range" id="tuneOffsetRRange" min="-800" max="800" step="1" value="0">
        </div>
        <div class="row">
          <label for="tuneOffsetP">Offset P:</label>
          <input type="number" id="tuneOffsetP" min="-800" max="800" step="1" value="0" style="width:90px;">
          <input type="range" id="tuneOffsetPRange" min="-800" max="800" step="1" value="0">
        </div>
      </div>
    </section>

    <section class="view" data-view="orientation">
      <h2>Orientation</h2>

      <div class="control-section">
        <h3 style="margin-top:0;">Embedded Orientation Scene</h3>
        <div class="row" style="margin-bottom:0.35rem;">
          <button id="orientationStreamToggleBtn" class="primary">Play Stream</button>
          <button id="orientationProjectionPlaneBtn" class="primary" type="button">Planar</button>
          <button id="orientationProjectionSphereBtn" type="button">Globe</button>
        </div>
        <p id="orientationStatus" style="margin:0;opacity:0.85;">Initializing local permissions...</p>
        <div class="orientation-embed-wrap">
          <div id="orientationSceneHost" aria-label="Orientation Scene"></div>
        </div>
      </div>

      <div class="control-section">
        <h3 style="margin-top:0;">Orientation Tuneables</h3>
        <p class="tuneables-note">These settings apply live while orientation streaming is playing.</p>
        <div class="row">
          <label for="orientationSensitivity">Orientation Sensitivity:</label>
          <input type="number" id="orientationSensitivity" min="0" max="20" step="0.1" value="1.0" style="width:90px;">
          <input type="range" id="orientationSensitivityRange" min="0" max="20" step="0.1" value="1.0">
        </div>
        <div class="row">
          <label for="orientationHeadingGain">Heading Gain:</label>
          <input type="number" id="orientationHeadingGain" min="0" max="20" step="0.1" value="0.3" style="width:90px;">
          <input type="range" id="orientationHeadingGainRange" min="0" max="20" step="0.1" value="0.3">
        </div>
        <div class="row">
          <label for="orientationYawGain">Yaw Gain (X):</label>
          <input type="number" id="orientationYawGain" min="0" max="30" step="0.1" value="4.4" style="width:90px;">
          <input type="range" id="orientationYawGainRange" min="0" max="30" step="0.1" value="4.4">
        </div>
        <div class="row">
          <label for="orientationPitchGain">Pitch Gain (P):</label>
          <input type="number" id="orientationPitchGain" min="-30" max="30" step="0.1" value="-5.8" style="width:90px;">
          <input type="range" id="orientationPitchGainRange" min="-30" max="30" step="0.1" value="-5.8">
        </div>
        <div class="row">
          <label for="orientationRollGain">Roll Gain (R):</label>
          <input type="number" id="orientationRollGain" min="-30" max="30" step="0.1" value="-4.6" style="width:90px;">
          <input type="range" id="orientationRollGainRange" min="-30" max="30" step="0.1" value="-4.6">
        </div>
        <div class="row">
          <label for="orientationAccelYGain">Lateral Accel Gain (Y):</label>
          <input type="number" id="orientationAccelYGain" min="0" max="120" step="0.5" value="16.0" style="width:90px;">
          <input type="range" id="orientationAccelYGainRange" min="0" max="120" step="0.5" value="16.0">
        </div>
        <div class="row">
          <label for="orientationAccelZGain">Forward Accel Gain (Z):</label>
          <input type="number" id="orientationAccelZGain" min="0" max="120" step="0.5" value="14.0" style="width:90px;">
          <input type="range" id="orientationAccelZGainRange" min="0" max="120" step="0.5" value="14.0">
        </div>
        <div class="row">
          <label for="orientationAccelHGain">Height Accel Gain (H):</label>
          <input type="number" id="orientationAccelHGain" min="0" max="120" step="0.5" value="11.0" style="width:90px;">
          <input type="range" id="orientationAccelHGainRange" min="0" max="120" step="0.5" value="11.0">
        </div>
        <div class="row">
          <label for="orientationSmoothAlpha">Smoothing (alpha):</label>
          <input type="number" id="orientationSmoothAlpha" min="0.1" max="0.95" step="0.01" value="0.42" style="width:90px;">
          <input type="range" id="orientationSmoothAlphaRange" min="0.1" max="0.95" step="0.01" value="0.42">
        </div>
        <div class="row">
          <label for="orientationIntervalMs">Send Interval (ms):</label>
          <input type="number" id="orientationIntervalMs" min="20" max="200" step="1" value="85" style="width:90px;">
          <input type="range" id="orientationIntervalMsRange" min="20" max="200" step="1" value="85">
        </div>
        <div class="row">
          <label for="orientationSpeed">Speed (S):</label>
          <input type="number" id="orientationSpeed" min="0" max="10" step="0.1" value="0.8" style="width:90px;">
          <input type="range" id="orientationSpeedRange" min="0" max="10" step="0.1" value="0.8">
        </div>
        <div class="row">
          <label for="orientationAccel">Acceleration (A):</label>
          <input type="number" id="orientationAccel" min="0" max="10" step="0.1" value="0.6" style="width:90px;">
          <input type="range" id="orientationAccelRange" min="0" max="10" step="0.1" value="0.6">
        </div>
        <div class="row">
          <label for="orientationOffsetX">Offset X:</label>
          <input type="number" id="orientationOffsetX" min="-800" max="800" step="1" value="0" style="width:90px;">
          <input type="range" id="orientationOffsetXRange" min="-800" max="800" step="1" value="0">
        </div>
        <div class="row">
          <label for="orientationOffsetY">Offset Y:</label>
          <input type="number" id="orientationOffsetY" min="-800" max="800" step="1" value="0" style="width:90px;">
          <input type="range" id="orientationOffsetYRange" min="-800" max="800" step="1" value="0">
        </div>
        <div class="row">
          <label for="orientationOffsetZ">Offset Z:</label>
          <input type="number" id="orientationOffsetZ" min="-800" max="800" step="1" value="0" style="width:90px;">
          <input type="range" id="orientationOffsetZRange" min="-800" max="800" step="1" value="0">
        </div>
        <div class="row">
          <label for="orientationOffsetH">Offset H:</label>
          <input type="number" id="orientationOffsetH" min="0" max="70" step="1" value="30" style="width:90px;">
          <input type="range" id="orientationOffsetHRange" min="0" max="70" step="1" value="30">
        </div>
        <div class="row">
          <label for="orientationOffsetR">Offset R:</label>
          <input type="number" id="orientationOffsetR" min="-800" max="800" step="1" value="0" style="width:90px;">
          <input type="range" id="orientationOffsetRRange" min="-800" max="800" step="1" value="0">
        </div>
        <div class="row">
          <label for="orientationOffsetP">Offset P:</label>
          <input type="number" id="orientationOffsetP" min="-800" max="800" step="1" value="0" style="width:90px;">
          <input type="range" id="orientationOffsetPRange" min="-800" max="800" step="1" value="0">
        </div>
      </div>
    </section>

    <section class="view" data-view="streams">
      <h2>Stream Configuration</h2>
      <details id="streamsCameraDetails" class="streams-panel" open>
        <summary>Camera Streaming</summary>
        <div class="streams-panel-body">
          <div class="control-section">
            <h3 style="margin-top:0;">Camera Router Connection</h3>
            <div class="row">
              <label for="cameraRouterBaseInput">Camera Router URL:</label>
              <input type="text" id="cameraRouterBaseInput" placeholder="https://example.trycloudflare.com" style="flex:1;">
            </div>
            <div class="row">
              <label for="cameraRouterPasswordInput">Password:</label>
              <input type="password" id="cameraRouterPasswordInput" placeholder="camera router password" style="flex:1;">
            </div>
            <div class="row">
              <button id="cameraRouterAuthBtn" class="primary">Authenticate</button>
              <button id="cameraRouterRefreshBtn">Refresh Feeds</button>
              <button id="cameraRouterRotateSessionBtn">Rotate Session Key</button>
            </div>
            <p id="streamConfigStatus" style="margin:0.5rem 0 0 0;opacity:0.85;">Idle</p>
          </div>

          <div class="control-section">
            <h3 style="margin-top:0;">Mode and Feed</h3>
            <div class="row">
              <label for="cameraFeedSelect">Camera Feed:</label>
              <select id="cameraFeedSelect" style="flex:1;"></select>
            </div>
            <div class="row">
              <label for="cameraModeSelect">Protocol:</label>
              <select id="cameraModeSelect" style="flex:1;">
                <option value="webrtc" disabled>WebRTC (disabled)</option>
                <option value="mjpeg" selected>MJPEG stream (default)</option>
                <option value="jpeg">JPEG polling (fallback)</option>
                <option value="mpegts" disabled>MPEG-TS stream (disabled)</option>
              </select>
            </div>
            <div class="row">
              <label for="cameraProfileSelect">Capture Profile:</label>
              <select id="cameraProfileSelect" style="flex:1;"></select>
              <button id="cameraProfileApplyBtn" type="button">Apply</button>
            </div>
            <p id="cameraProfileStatus" style="margin:0.25rem 0 0 0;opacity:0.82;font-size:0.85rem;">No camera profile selected</p>
            <div class="row">
              <button id="cameraPreviewStartBtn" class="primary">Start Preview</button>
              <button id="cameraPreviewStopBtn">Stop Preview</button>
            </div>
          </div>

          <div class="control-section">
            <div class="section-header">
              <h3 style="margin-top:0;">Preview</h3>
              <button id="cameraPreviewShareBtn" type="button">Share</button>
            </div>
            <div class="stream-preview-wrap">
              <button id="cameraPreviewPinBtn" class="stream-pin-btn" type="button" aria-label="Pin stream preview" title="Pin stream preview">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M7 3h10l-2 6v3l3 3v2h-5v4l-2-1-2 1v-4H4v-2l3-3V9L7 3z"></path>
                </svg>
              </button>
              <img id="cameraPreviewImage" alt="Camera Preview" style="display:none;">
              <video id="cameraPreviewVideo" autoplay muted playsinline controls style="display:none;"></video>
            </div>
          </div>

          <div class="control-section">
            <h3 style="margin-top:0;">Feed Status</h3>
            <div id="cameraFeedList" class="stream-feed-list"></div>
          </div>
          <div class="control-section">
            <h3 style="margin-top:0;">IMU Telemetry</h3>
            <div class="imu-readout-grid">
              <div class="imu-readout-item">
                <div class="imu-readout-label">Accel (m/s^2)</div>
                <code id="streamImuAccel" class="imu-readout-value">--</code>
              </div>
              <div class="imu-readout-item">
                <div class="imu-readout-label">Gyro (rad/s)</div>
                <code id="streamImuGyro" class="imu-readout-value">--</code>
              </div>
            </div>
            <p id="streamImuMeta" class="imu-readout-meta">IMU idle</p>
          </div>
        </div>
      </details>

      <details id="streamsAudioDetails" class="streams-panel">
        <summary>Audio Streaming</summary>
        <div class="streams-panel-body">
          <div class="control-section">
            <h3 style="margin-top:0;">Audio Router Connection</h3>
            <div class="row">
              <label for="audioRouterBaseInput">Audio Router URL:</label>
              <input type="text" id="audioRouterBaseInput" placeholder="https://example.trycloudflare.com" style="flex:1;">
            </div>
            <div class="row">
              <label for="audioRouterPasswordInput">Password:</label>
              <input type="password" id="audioRouterPasswordInput" placeholder="audio router password" style="flex:1;">
            </div>
            <div class="row">
              <button id="audioRouterAuthBtn" class="primary">Authenticate</button>
              <button id="audioRouterRefreshBtn">Refresh Devices</button>
              <button id="audioRouterRotateSessionBtn">Rotate Session Key</button>
            </div>
            <p id="audioStreamStatus" style="margin:0.5rem 0 0 0;opacity:0.85;">Idle</p>
          </div>

          <div class="control-section">
            <h3 style="margin-top:0;">System Device Routing</h3>
            <div class="row">
              <label for="audioInputDeviceSelect">Service Input Device:</label>
              <select id="audioInputDeviceSelect" style="flex:1;"></select>
            </div>
            <div class="row">
              <label for="audioOutputDeviceSelect">Service Output Device:</label>
              <select id="audioOutputDeviceSelect" style="flex:1;"></select>
            </div>
            <div class="row">
              <button id="audioDeviceApplyBtn" type="button">Apply Device Selection</button>
            </div>
            <div id="audioDeviceList" class="stream-feed-list"></div>
          </div>

          <div class="control-section">
            <div class="section-header">
              <h3 style="margin-top:0;">Bidirectional Bridge</h3>
              <label for="audioBrowserMicToggle" style="min-width:auto;display:flex;align-items:center;gap:0.4rem;">
                <input id="audioBrowserMicToggle" type="checkbox" checked>
                Send Browser Mic
              </label>
            </div>
            <div class="row">
              <button id="audioBridgeStartBtn" class="primary" type="button">Start Audio Bridge</button>
              <button id="audioBridgeStopBtn" type="button">Stop Audio Bridge</button>
            </div>
            <audio id="audioRemotePlayer" autoplay controls playsinline></audio>
            <p id="audioConnectionMeta" class="imu-readout-meta">No active audio bridge.</p>
          </div>
        </div>
      </details>
    </section>

    <section class="view" data-view="hybrid">
      <h2>Hybrid Control</h2>
      <div class="hybrid-tabs" role="tablist" aria-label="Hybrid Modes">
        <button id="hybridTabTouchBtn" class="hybrid-tab active" data-hybrid-tab="touch" type="button">Touch</button>
        <button id="hybridTabMorphBtn" class="hybrid-tab" data-hybrid-tab="morph" type="button">Morphtarget</button>
        <button id="hybridTabOrientationBtn" class="hybrid-tab" data-hybrid-tab="orientation" type="button">Orientation</button>
      </div>

      <div id="hybridTabTouch" class="hybrid-tab-panel active">
        <div class="control-section">
          <div id="hybridFeedButtons" class="hybrid-feed-buttons" role="group" aria-label="Available camera feeds"></div>
          <p id="hybridStatus" style="margin:0.25rem 0 0 0;opacity:0.85;">Authenticate with camera router to load feeds.</p>
        </div>

        <div class="control-section">
          <div class="section-header">
            <h3 style="margin-top:0;">Preview + Motion Overlay</h3>
            <button id="hybridRefreshFeedsBtn" type="button">Refresh Feeds</button>
          </div>
          <div class="hybrid-preview-layout">
            <div id="hybridPreviewWrap" class="hybrid-preview-wrap">
              <img id="hybridPreviewImage" alt="Hybrid Preview" style="display:none;">
              <div id="hybridPreviewEmpty" class="hybrid-preview-empty">Authenticate and select a camera feed.</div>
              <div id="hybridDragSurface" class="hybrid-drag-surface" aria-label="Hybrid drag control area"></div>
              <button class="hybrid-arrow hybrid-arrow-up" type="button" data-axis="P" data-delta="8" aria-label="Pitch Up">&#9650;</button>
              <button class="hybrid-arrow hybrid-arrow-right" type="button" data-axis="X" data-delta="-8" aria-label="Yaw Right">&#9654;</button>
              <button class="hybrid-arrow hybrid-arrow-down" type="button" data-axis="P" data-delta="-8" aria-label="Pitch Down">&#9660;</button>
              <button class="hybrid-arrow hybrid-arrow-left" type="button" data-axis="X" data-delta="8" aria-label="Yaw Left">&#9664;</button>
            </div>
            <div class="hybrid-height-control">
              <label class="hybrid-height-label" for="hybridHeightSlider">Height</label>
              <input id="hybridHeightSlider" class="hybrid-height-slider" type="range" min="0" max="70" step="1" value="0" aria-label="Hybrid height adjustment">
              <output id="hybridHeightValue" class="hybrid-height-value" for="hybridHeightSlider">H0</output>
            </div>
          </div>
          <p id="hybridControlReadout" class="hybrid-control-readout">X0,Y0,Z0,H0,S1,A1,R0,P0</p>
          <p class="hybrid-control-hint">
            Left drag: yaw/pitch. Right drag (or Ctrl/Cmd + left drag): lateral/forward-back.
            Middle drag (or Shift + left drag): roll/height.
            Scroll or right slider: height. Hold arrows for continuous trim.
          </p>
          <div class="imu-readout-grid">
            <div class="imu-readout-item">
              <div class="imu-readout-label">Accel (m/s^2)</div>
              <code id="hybridImuAccel" class="imu-readout-value">--</code>
            </div>
            <div class="imu-readout-item">
              <div class="imu-readout-label">Gyro (rad/s)</div>
              <code id="hybridImuGyro" class="imu-readout-value">--</code>
            </div>
          </div>
          <p id="hybridImuMeta" class="imu-readout-meta">IMU idle</p>
        </div>
        <div id="hybridAudioMount"></div>
      </div>

      <div id="hybridTabMorph" class="hybrid-tab-panel"></div>
      <div id="hybridTabOrientation" class="hybrid-tab-panel"></div>
    </section>

    <section class="view" data-view="debug">
      <h2>Debug</h2>
      <details class="streams-panel" open>
        <summary>Adapter Controls</summary>
        <div class="streams-panel-body">
          <div class="debug-tabs" role="tablist" aria-label="Debug Control Modes">
            <button class="debug-tab active" data-debug-control="direct" type="button">Direct</button>
            <button class="debug-tab" data-debug-control="euler" type="button">Euler</button>
            <button class="debug-tab" data-debug-control="head" type="button">Head</button>
            <button class="debug-tab" data-debug-control="quaternion" type="button">Quaternion</button>
          </div>
          <div id="debugControlMount"></div>
        </div>
      </details>
      <details class="streams-panel">
        <summary>Camera Stream Test</summary>
        <div id="debugCameraMount" class="streams-panel-body"></div>
      </details>
      <details class="streams-panel">
        <summary>Audio Stream Test</summary>
        <div class="streams-panel-body">
          <div id="debugAudioMount"></div>
          <div class="control-section">
            <div class="row">
              <button id="debugAudioStartBtn" class="primary" type="button">Start Audio Bridge</button>
              <button id="debugAudioStopBtn" type="button">Stop Audio Bridge</button>
              <button id="debugAudioRefreshBtn" type="button">Refresh Audio Devices</button>
            </div>
            <p id="debugAudioStatus" class="imu-readout-meta">No debug audio actions yet.</p>
          </div>
        </div>
      </details>
      <details class="streams-panel">
        <summary>Service Actions</summary>
        <div class="streams-panel-body">
          <div class="row">
            <button onclick="sendHomeCommand()" type="button">Home Brute</button>
            <button onclick="sendHomeSoftCommand()" type="button">Home Soft</button>
            <button onclick="resetAdapterPort(false)" type="button">Reset Port</button>
          </div>
        </div>
      </details>
    </section>
      </div>

      <footer id="console"></footer>
    </main>
  </div>

  <div id="pinnedStreamPane" class="pinned-stream-pane" aria-label="Pinned stream preview">
    <img id="pinnedStreamImage" alt="Pinned stream preview">
    <button id="pinnedStreamCloseBtn" class="pinned-stream-close" type="button" aria-label="Close pinned preview" title="Close">x</button>
    <div id="pinnedStreamResizeHandle" class="pinned-stream-resize" aria-hidden="true"></div>
  </div>

</body>
</html>
